<!-- TOC -->

- [1. crontab](#1-crontab)
    - [简介](#简介)
    - [命令详解](#命令详解)
    - [1.1. 列举当前任务](#11-列举当前任务)
    - [添加任务](#添加任务)
    - [编辑任务](#编辑任务)
    - [删除任务](#删除任务)
    - [示例](#示例)
    - [注意事项](#注意事项)
        - [环境变量](#环境变量)
        - [注意清理系统用户的邮件日志](#注意清理系统用户的邮件日志)
    - [参考](#参考)
- [at](#at)

<!-- /TOC -->



# 1. crontab

## 简介
crond是linux下用来周期性的执行某种任务或等待处理某些事件的一个守护进程，crond进程每分钟会定期检查是否有要执行的任务。

* 系统任务调度：系统周期性所要执行的工作，比如写缓存数据到硬盘、日志清理等。在/etc目录下有一个crontab文件，这个就是系统任务调度的配置文件。
* 用户任务调度：用户定期要执行的工作，比如用户数据备份、定时邮件提醒等。用户可以使用 crontab 工具来定制自己的计划任务。所有用户定义的crontab 文件都被保存在 /var/spool/cron目录中。其文件名与用户名一致。

使用者权限文件：
* `/etc/cron.deny`: 该文件中所列用户不允许使用crontab命令。
* `/etc/cron.allow`: 该文件中所列用户允许使用crontab命令。

crontab文件的含义:

前五段是时间设定段，第六段是要执行的命令段。格式如下：

```
minute   hour   day   month   week   command
```

* minute： 表示分钟，可以是从0到59之间的任何整数。
* hour：表示小时，可以是从0到23之间的任何整数。
* day：表示日期，可以是从1到31之间的任何整数。
* month：表示月份，可以是从1到12之间的任何整数。
* week：表示星期几，可以是从0到7之间的任何整数，这里的0或7代表星期日。
* command：要执行的命令，可以是系统命令，也可以是自己编写的脚本文件。多个命令间用 `;` 分隔。

在以上各个字段中，还可以使用以下特殊字符：

* 星号（*）：代表所有可能的值，例如month字段如果是星号，则表示在满足其它字段的制约条件后每月都执行该命令操作。
* 逗号（,）：可以用逗号隔开的值指定一个列表范围，例如，“1,2,5,7,8,9”
* 中杠（-）：可以用整数之间的中杠表示一个整数范围，例如“2-6”表示“2,3,4,5,6”
* 正斜线（/）：可以用正斜线指定时间的间隔频率，例如“0-23/2”表示每两小时执行一次。同时正斜线可以和星号一起使用，例如*/10，如果用在minute字段，表示每十分钟执行一次。


## 命令详解

格式：

```bash
crontab [-u user] file
crontab [-u user] [ -e | -l | -r ]
```

参数：

+ `-u user`：用来设定某个用户的crontab服务，例如，“-u ixdba”表示设定ixdba用户的crontab服务，此参数一般有root用户来运行。
+ `file`：file是命令文件的名字,表示将file做为crontab的任务列表文件并载入crontab。如果在命令行中没有指定这个文件，crontab命令将接受标准输入（键盘）上键入的命令，并将它们载入crontab。
+ `-e`：编辑某个用户的crontab文件内容。如果不指定用户，则表示编辑当前用户的crontab文件。
+ `-l`：显示某个用户的crontab文件内容，如果不指定用户，则表示显示当前用户的crontab文件内容。
+ `-r`：从 `/var/spool/cron` 目录中删除某个用户的crontab文件，如果不指定用户，则默认删除当前用户的crontab文件。
+ `-i`：在删除用户的crontab文件时给确认提示。


## 1.1. 列举当前任务

```bash
crontab -l
```

## 添加任务
编辑文件`mycron`:

```
# 打印当前时间
# 分 时 天 月 周 命令
* * * * * echo $(date) >> /home/xxx/crontab.out
```

执行：`crontab mycron`。

## 编辑任务

```
crontab -e
```

会使用 `$EDIROT` 指定的编辑器进行编辑。

## 删除任务

```
crontab -r
```

## 示例

* 每分钟执行一次命令：`* * * * * command`
* 每小时的第3和第15分钟执行: `3,15 * * * * command`
* 在上午8点到11点的第3和第15分钟执行: `3,15 8-11 * * * command`
* 每隔两天的上午8点到11点的第3和第15分钟执行: `3,15 8-11 */2 * * command`
* 每个星期一的上午8点到11点的第3和第15分钟执行: `3,15 8-11 * * 1 command`
* 每晚的21:30重启smb: `30 21 * * * /etc/init.d/smb restart`
* 每小时执行/etc/cron.hourly目录内的脚本: `01   *   *   *   *     root run-parts /etc/cron.hourly`, 去掉`run-parts`后面就可以写要运行的某个脚本名，而不是目录名


## 注意事项

### 环境变量

手动执行任务没有问题，但crontab中的任务却没有执行，可能是没有配置环境变量。系统自动执行任务时不会加载任何环境变量。

还需注意以下几点：
1. 文件路径要写全路径。
2. 用到环境变量时使用 `source` 命令引入，或者 `export` 设置。

    ```bash
    source /etc/profile
    export PATH=/home/xxx/bin
    ```

3. 在 crontab 文件中的命令栏中引入环境变量：

    ```
    0 * * * * . /etc/profile; /bin/sh /var/www/java/restart_audit.sh
    ```


### 注意清理系统用户的邮件日志

每条任务调度执行完毕，系统都会将任务输出信息通过电子邮件的形式发送给当前系统用户，这样日积月累，日志信息会非常大，可能会影响系统的正常运行。

可以将输出重定向到指定文件或者忽略输出。



## 参考
+ [每天一个linux命令（50）：crontab命令](http://www.cnblogs.com/peida/archive/2013/01/08/2850483.html)



# at