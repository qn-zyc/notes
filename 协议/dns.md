

# 缩写

* `RR`: Resource Record

# 类型

* `A`: IP地址。
* `MX`: 邮件交换
* `NS`: 名字服务器。说明一个域的授权名字服务器。
* `CNAME`: 规范名字(canonical name)，表示一个域名，有规范名字的域名也叫做别名。
* `HINFO`: 主机信息，包括主机CPU和操作系统。

# DNS 协议

DNS报文，无论是请求报文还是应答报文都是统一格式：

![](dns/1.png)

* 标识：客户端设置的序列号，用来匹配应答的。

## 标志

![](dns/2.png)

- `QR`：定义报文类型，QR=0表示查询报文,1表示响应报文。
- `opcode`: 定义查询或响应的类型，0表示标准的，1表示反向的，2表示服务器状态请求。
- `AA(Authoritative answer)`：授权回答，只用于响应报文。1表示该域名服务器是该区域的授权服务器；
- `TC(Truncated)`: 可截断的，使用UDP服务时，若响应报文的总长度超过512B，则只返回前512B，并把该字段置1，客户端重新使用TCP发送查询。
- `RD(Recursion Desired)`: 期望递归，0表示DNS客户进程希望迭代查询，1表示DNS客户希望递归查询；
- `RA(Recursion Available)`:递归可用，只用于响应报文。若域名服务器支持递归，则该服务器便在响应报文中将 RA=1。
- `(zero)`：保留字段，必须为0.
- `rcode`: 表示在响应中的差错状态，只有权限服务器才能做出该判断。具体如下：
    - 0(NOERROR)：无差错
    - 1(FORMERR)：格式差错，DNS 服务器不理解更新请求。
    - 2(SERVFAIL)：问题出在域名服务器上,DNS 服务器遇到内部错误，如转发超时。
    - 3(NXDOMAIN)：名字差错，应该存在的名称不存在。
    - 4(NOTIMP)：查询类型不支持
    - 5(REFUSED)：DNS 服务器将拒绝执行更新
    - 6~15：保留

## 查询问题

![](dns/3.png)

* 查询名：包含域名的可变长度字段，每个域以计数开头，最后一个字符为0（零）,每个字符占1B。如：www.baidu.com可以这样记录：3www5baidu3com0；
* 查询类型：每一个问题的查询有一个类型，响应也有一个类型。

    ![](dns/4.png)

    其中最常用的查询是A类型和PTR类型：A类型就是域名到IP地址，PTR查询就是IP地址到域名。

* 查询类：定义了使用DNS的特定协议，1表示因特网。


## 响应中的资源记录 RR

响应报文中的三种资源记录（回答、授权、附加）均采用相同的格式，如下图所示：

![](dns/5.png)

- 生存时间：以s为单位，定义了此回答的有效期（一般为2天）。在这段有效期内，客户长须可以将此回答保存在caching中，当TTL设置为0表示该资源记录只能用于本次回答，而不能存放在caching中；
- 资源数据长度：用于记录后面资源数据的长度；
- 资源数据：包含对查询的回答（在回答部分），或者权限服务器的域名（在授权部分），或者一些附加信息（在附加信息部分）。这个字段的格式和内容取决于类型字段的值。它可以是下述之一：
    - a.数值  这个数以八位组为单位，例如IPv4是4个八位组的整数倍；
    - b.域名   记录域名由两种方法，方法一就是查询报文中所提到的如:3www5baidu3com0，方法二是采用指针的方法，因为一个回答报文中可能同时包含多种资源记录RR，而对于每一种资源记录RR，都会重复域名部分，为了节约空间，在后面的RR（非第一个RR）的域名部分，我们采用偏移指针的方式。偏移指针（占用16位）指的是偏离DNS响应报文首部最开始的位置（以字节为单位）且以11开头，偏移值范围为0~63B。例如偏离首部最开始部分12B可以记录为：1100 0000 0000 1100。
        Notice:当在响应报文中出现域名重复时，DNS要求用偏移指针来代替域名，DNS定义了2B的偏移指针，格式“11+偏移长度”，最高位固定为11，从而实现压缩。
    - c.字符串 字符串用1B的长度字段紧跟着一串长度的字符。长度字段并不像域名长度哪有受限。字符串可以多打255个字符（包括长度字段）



# 查看 local DNS

查看文件 `/etc/resolv.conf`。


# 高速缓存

* 为了告知DNS客户程序这个响应是来自caching，而不是一个授权的信息源，这个服务器要把响应标记为未授权的。（dig 中的 AUTHORITY ?）





# 参考

* 《TCP/IP详解 卷1:协议》
* [DNS协议](http://blog.csdn.net/jxh_123/article/details/26055215)
* [DNS 协议](https://technet.microsoft.com/zh-cn/library/dd197470(v=ws.10).aspx)